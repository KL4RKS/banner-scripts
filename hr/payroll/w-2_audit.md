# W-2 Notes and Reports
These can be run and fixed throughout the year to make the W-2 process smoother in January



## Historical Issues and Resolutions

- Negative Amounts in Box 12?
- PERDTOT year not matching PHRHIST year - Watch for PHRHIST_EVENT_DATE mismatch with the payroll year/month

### PERDTOT year not matching PHRHIST year
Watch for PHRHIST_EVENT_DATE mismatch with the payroll year/month
We found that PERDTOT had records for 2023 that were on PHRDEDN 2022 SA 11 with a 01/25/23 event/post date. Argos Report off by $92.77 - ended up being a phrhist_event_date in 2023 for a 2022 SA 11 supplemental
Because the discrepancy report is an inner join, it was not returning the records because phrhist records didn't exist for 2023. Need to make it a full outer join.

```sql
-- 2024-01-03 UPDATE TO A FULL OUTER JOIN FOR WHEN RECORDS DONT EXIST ON ONE TABLE FOR THE YEAR
SELECT F_GETSPRIDENID(COALESCE(PHRDEDN_PIDM,PERDTOT_PIDM)) ID
, F_FORMAT_NAME(COALESCE(PHRDEDN_PIDM,PERDTOT_PIDM), 'LFMI') NAME
, COALESCE(PHRDEDN_PIDM,PERDTOT_PIDM) PIDM
, COALESCE(PHRDEDN_BDCA_CODE,PERDTOT_BDCA_CODE) BDCA_CODE
, PHRDEDN.EE_AMT PHRDEDN_EE_AMT
, PHRDEDN.ER_AMT PHRDEDN_ER_AMT
, PHRDEDN.APL_GROSS PHRDEDN_APL_GROSS
, PERDTOT.EE_AMT PERDTOT_EE_AMT
, PERDTOT.ER_AMT PERDTOT_ER_AMT
, PERDTOT.APL_GROSS PERDTOT_APL_GROSS
, COALESCE(PHRDEDN.EE_AMT,0) - COALESCE(PERDTOT.EE_AMT,0) EE_DIFF
, COALESCE(PHRDEDN.ER_AMT,0) - COALESCE(PERDTOT.ER_AMT,0) ER_DIFF
, COALESCE(PHRDEDN.APL_GROSS,0) - COALESCE(PERDTOT.APL_GROSS,0) APL_GROSS_DIFF
FROM
  (
    SELECT PHRDEDN_PIDM
    , PHRDEDN_BDCA_CODE
    , SUM(PHRDEDN_EMPLOYEE_AMT) EE_AMT
    , SUM(PHRDEDN_EMPLOYER_AMT) ER_AMT
    , SUM(PHRDEDN_APPLICABLE_GROSS) APL_GROSS
    FROM phrdedn
    WHERE phrdedn_year = :main_eb_year
    GROUP BY PHRDEDN_PIDM, PHRDEDN_BDCA_CODE
  ) PHRDEDN
FULL OUTER JOIN
  (
    SELECT PERDTOT_PIDM
    , PERDTOT_BDCA_CODE
    , SUM(PERDTOT_EMPL_AMT) EE_AMT
    , SUM(PERDTOT_EMPR_AMT) ER_AMT
    , SUM(PERDTOT_APPL_GRS) APL_GROSS
    FROM PERDTOT
    WHERE PERDTOT_YEAR = :main_eb_year
    GROUP BY PERDTOT_PIDM, PERDTOT_BDCA_CODE
  ) PERDTOT
  ON PERDTOT.PERDTOT_PIDM = PHRDEDN.PHRDEDN_PIDM
    AND PERDTOT.PERDTOT_BDCA_CODE = PHRDEDN.PHRDEDN_BDCA_CODE
WHERE ( COALESCE(PERDTOT.EE_AMT,0) <> COALESCE(PHRDEDN.EE_AMT,0)
      OR  COALESCE(PERDTOT.ER_AMT,0) <> COALESCE(PHRDEDN.ER_AMT,0)
      OR  COALESCE(PERDTOT.APL_GROSS,0) <> COALESCE(PHRDEDN.APL_GROSS,0) )
ORDER BY 4,3
;
```
